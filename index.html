<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>LIVE HUNTER</title>
    <style>
        :root { --gold: #d4af37; --paper: #e6d5b8; --ink: #2b1e16; --red: #a00000; --blue: #2196f3; }
        body, html { margin: 0; padding: 0; height: 100vh; width: 100vw; background: #000; font-family: 'Palatino', serif; color: var(--gold); overflow: hidden; position: fixed; }
        .app-container { height: 100vh; display: flex; flex-direction: column; padding-top: env(safe-area-inset-top); }
        header { flex-shrink: 0; padding: 10px 0; background: rgba(0,0,0,0.9); text-align: center; border-bottom: 2px solid var(--gold); z-index: 10; }
        .nav-bar { display: flex; justify-content: space-around; padding: 5px; }
        .nav-btn { background: none; border: 1px solid var(--gold); color: var(--gold); padding: 8px 12px; font-size: 0.75rem; border-radius: 3px; }
        .nav-btn.current { background: var(--gold); color: #000; }
        
        .screen { display: none; flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; background-image: url('https://www.transparenttextures.com/patterns/dark-wood.png'); padding-bottom: 80px; }
        .active { display: flex; flex-direction: column; align-items: center; }

        /* --- HUNT SCREEN (LIVE CAMERA) --- */
        .camera-container {
            width: 100%; height: 250px; position: relative; background: #000; overflow: hidden; flex-shrink: 0;
            border-bottom: 2px solid var(--gold);
        }
        #video-feed { width: 100%; height: 100%; object-fit: cover; }
        /* 照準オーバーレイ */
        .reticle {
            position: absolute; inset: 0; pointer-events: none;
            display: flex; justify-content: center; align-items: center;
        }
        .reticle::before, .reticle::after { content: ''; position: absolute; border: 2px solid var(--gold); }
        .reticle::before { width: 40px; height: 40px; border-radius: 50%; border-style: dashed; animation: rotate 4s linear infinite; }
        .reticle::after { width: 100px; height: 1px; background: rgba(212, 175, 55, 0.3); }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .shutter-btn {
            width: 70px; height: 70px; border-radius: 50%; border: 4px solid #fff;
            background: rgba(255,255,255,0.2); position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
            box-shadow: 0 0 15px var(--gold); z-index: 20;
        }

        .recent-names { display: flex; flex-wrap: wrap; gap: 8px; padding: 12px; justify-content: center; width: 100%; }
        .name-chip { background: var(--ink); color: var(--gold); border: 1px solid var(--gold); padding: 8px 15px; border-radius: 20px; font-size: 0.75rem; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); }

        /* --- DUEL --- */
        #board { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 15px; width: 100%; box-sizing: border-box; }
        .slot { aspect-ratio: 3/5.2; position: relative; }
        .poster { background-color: var(--paper); padding: 6px; display: flex; flex-direction: column; color: var(--ink); border: 1px solid #8b4513; position: absolute; inset: 0; box-shadow: 3px 3px 8px rgba(0,0,0,0.6); }
        .poster img { width: 100%; height: 50%; object-fit: cover; border: 1px solid var(--ink); }
        .eliminate-btn { background: var(--red); color: white; border: none; padding: 12px 0; font-weight: bold; border-radius: 2px; margin-top: auto; }

        /* --- ARCHIVE --- */
        #archive-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; padding: 10px; width: 100%; box-sizing: border-box; }
        .archive-card { background: var(--paper); border: 1px solid #8b4513; aspect-ratio: 3/6; display: flex; flex-direction: column; position: relative; font-size: 0.5rem; color: var(--ink); }
        .archive-card img { width: 100%; height: 45%; object-fit: cover; }
        .stamp { position: absolute; top: 10%; left: 0; right: 0; text-align: center; color: var(--red); font-weight: bold; border: 1.5px solid var(--red); transform: rotate(-15deg); font-size: 0.6rem; background: rgba(255,255,255,0.7); z-index: 5; }

        /* 銃声とエフェクト */
        .bullet-hole { position: absolute; width: 30px; height: 30px; background: radial-gradient(circle, #000 20%, #222 40%, transparent 70%); top: 30%; left: 50%; transform: translate(-50%, -50%); z-index: 10; display: none; }
        .is-shot { animation: shoot-down 0.7s ease-in forwards; pointer-events: none; }
        @keyframes shoot-down { 0% { transform: scale(1); } 100% { transform: translateY(100vh) rotate(30deg); opacity: 0; } }
        .shake { animation: shake-anim 0.05s 4; }
        @keyframes shake-anim { 0%, 100% { transform: translate(0); } 50% { transform: translate(10px, 10px); } }

        canvas#capture-canvas { display: none; }
    </style>
</head>
<body>
    <div class="app-container" id="main-body">
        <header>
            <h1 style="font-size: 1rem; margin:0; letter-spacing: 2px;">LIVE HUNTER</h1>
            <div class="nav-bar">
                <button class="nav-btn" id="btn-hunt" onclick="showScreen('hunt')">HUNT</button>
                <button class="nav-btn" id="btn-board" onclick="showScreen('board')">DUEL</button>
                <button class="nav-btn" id="btn-archive" onclick="showScreen('archive')">ARCHIVE</button>
            </div>
        </header>

        <div id="screen-hunt" class="screen active">
            <div class="camera-container">
                <video id="video-feed" autoplay playsinline></video>
                <div class="reticle"></div>
                <button class="shutter-btn" onclick="captureTarget()"></button>
            </div>
            <div id="ammo-status" style="padding: 10px; font-size: 0.8rem; text-align: center;">STOCK: 0 / 10</div>
            <div class="recent-names" id="recent-names"></div>
            <div id="stock-list" style="width:100%; padding:15px; box-sizing:border-box;"></div>
        </div>

        <div id="screen-board" class="screen"><div id="board"></div></div>

        <div id="screen-archive" class="screen">
            <div style="padding:15px; text-align:center; font-size:0.7rem;">
                <button style="background:var(--gold); border:none; padding:12px; font-weight:bold; width:100%; border-radius:5px; margin-bottom:10px;" onclick="copyAIText()">報告書をコピー</button>
                <div id="usage-text">STORAGE: 0.00 MB</div>
                <button style="background:none; border:1px solid var(--red); color:var(--red); padding:5px 10px; margin-top:5px;" onclick="clearOldArchives()">古い順に5件削除</button>
            </div>
            <div id="archive-grid"></div>
        </div>
    </div>

    <canvas id="capture-canvas"></canvas>

<script>
    let targets = JSON.parse(localStorage.getItem('w_v12_act') || '[]');
    let archives = JSON.parse(localStorage.getItem('w_v12_arc') || '[]');
    let knownEnemies = JSON.parse(localStorage.getItem('w_v12_knw') || '[]');
    const video = document.getElementById('video-feed');
    const canvas = document.getElementById('capture-canvas');

    // カメラの開始
    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment', width: { ideal: 640 }, height: { ideal: 480 } }, 
                audio: false 
            });
            video.srcObject = stream;
        } catch (err) {
            console.error("Camera Error: ", err);
            alert("カメラへのアクセスを許可してください。");
        }
    }

    function showScreen(mode) {
        save();
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('current'));
        document.getElementById(`screen-${mode}`).classList.add('active');
        document.getElementById(`btn-${mode}`).classList.add('current');
        render();
    }

    // キャプチャして保存
    function captureTarget() {
        if (targets.length >= 10) { alert("FULL!"); return; }
        
        let title = prompt("ターゲット名 (16文字以内):", "UNTITLED");
        title = (title || "UNTITLED").slice(0, 16).toUpperCase();

        canvas.width = 300;
        canvas.height = 300 * (video.videoHeight / video.videoWidth);
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const imageData = canvas.toDataURL('image/jpeg', 0.6);
        addNewTarget(title, imageData);
        playShutterSound();
    }

    function quickHunt(enemy) {
        if (targets.length >= 10) { alert("FULL!"); return; }
        addNewTarget(enemy.title, enemy.image);
        alert(`${enemy.title} を捕捉！`);
    }

    function addNewTarget(title, image) {
        const now = new Date();
        targets.push({ id: Date.now(), title: title, image: image, h: `${now.getMonth()+1}/${now.getDate()}`, d: null, isPending: false });
        knownEnemies = [{ title: title, image: image }, ...knownEnemies.filter(e => e.title !== title)].slice(0, 15);
        save();
    }

    function render() {
        // HUNT: ボタン表示
        const recentDiv = document.getElementById('recent-names');
        recentDiv.innerHTML = '';
        knownEnemies.forEach(enemy => {
            const chip = document.createElement('div');
            chip.className = 'name-chip'; chip.innerText = enemy.title;
            let timer;
            chip.ontouchstart = () => timer = setTimeout(() => { if(confirm(`${enemy.title}を削除？`)) { knownEnemies = knownEnemies.filter(e=>e.title!==enemy.title); save(); } }, 800);
            chip.ontouchend = () => { if(timer) { clearTimeout(timer); quickHunt(enemy); } };
            chip.onclick = () => { if(!window.ontouchstart) quickHunt(enemy); };
            recentDiv.appendChild(chip);
        });

        const stockList = document.getElementById('stock-list');
        stockList.innerHTML = `<h3 style="font-size:0.7rem; border-bottom:1px solid var(--gold);">CURRENT STOCK</h3>`;
        targets.forEach(t => {
            stockList.innerHTML += `<div style="display:flex; align-items:center; margin-bottom:5px; font-size:0.75rem;"><img src="${t.image}" style="width:30px; height:30px; object-fit:cover; margin-right:10px;"> ${t.title}</div>`;
        });
        document.getElementById('ammo-status').innerText = `STOCK: ${targets.length} / 10`;

        // DUEL
        const board = document.getElementById('board');
        board.innerHTML = '';
        targets.forEach(t => {
            const slot = document.createElement('div'); slot.className = 'slot';
            if (t.isPending) { slot.innerHTML = `<div style="display:flex; height:100%; justify-content:center; align-items:center; opacity:0.1; font-size:2rem;">☠</div>`; }
            else { slot.innerHTML = `<div class="poster" id="p-${t.id}"><img src="${t.image}"><div class="bullet-hole"></div><div class="poster-info"><p style="text-align:center; font-size:0.7rem; margin:0;">${t.title}</p><button class="eliminate-btn" onclick="shoot(${t.id})">SHOOT</button></div></div>`; }
            board.appendChild(slot);
        });

        // ARCHIVE
        const usedSpace = encodeURI(JSON.stringify(localStorage)).split(/%..|./).length - 1;
        document.getElementById('usage-text').innerText = `STORAGE: ${(usedSpace / 1024 / 1024).toFixed(2)} MB / 5.00 MB`;
        const arcGrid = document.getElementById('archive-grid'); arcGrid.innerHTML = '';
        archives.slice().reverse().forEach((t, idx) => {
            const realIdx = archives.length - 1 - idx;
            arcGrid.innerHTML += `<div class="archive-card"><div class="stamp">DEAD</div><img src="${t.image}"><div style="padding:3px; text-align:center; flex-grow:1; display:flex; flex-direction:column; justify-content:space-between;"><div style="font-weight:bold; font-size:0.5rem;">${t.title}</div><div style="font-size:0.4rem; opacity:0.7;">H:${t.h} D:${t.d}</div><button style="background:var(--blue); color:#fff; border:none; font-size:0.4rem;" onclick="restore(${realIdx})">RESTORE</button></div></div>`;
        });
    }

    function shoot(id) {
        playGunshot();
        document.getElementById('main-body').classList.add('shake');
        const poster = document.getElementById(`p-${id}`);
        poster.querySelector('.bullet-hole').style.display = 'block'; poster.classList.add('is-shot');
        const target = targets.find(t => t.id === id);
        if (target) { target.isPending = true; target.d = `${new Date().getMonth()+1}/${new Date().getDate()}`; archives.push({ ...target, isPending: false }); }
        setTimeout(() => document.getElementById('main-body').classList.remove('shake'), 500);
    }

    function save() {
        targets = targets.filter(t => !t.isPending);
        localStorage.setItem('w_v12_act', JSON.stringify(targets));
        localStorage.setItem('w_v12_arc', JSON.stringify(archives));
        localStorage.setItem('w_v12_knw', JSON.stringify(knownEnemies));
        render();
    }

    function clearOldArchives() { if (archives.length > 0 && confirm("5件削除しますか？")) { archives.splice(0, 5); save(); } }
    function restore(idx) { if (targets.length < 10) { const r = archives.splice(idx, 1)[0]; r.isPending = false; targets.push(r); save(); } }

    function playShutterSound() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator(); const g = ctx.createGain();
        osc.type = 'sine'; osc.frequency.setValueAtTime(1000, ctx.currentTime);
        g.gain.setValueAtTime(0.3, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
        osc.connect(g); g.connect(ctx.destination); osc.start(); osc.stop(ctx.currentTime + 0.1);
    }

    function playGunshot() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const b = ctx.createOscillator(); const bg = ctx.createGain();
        b.type = 'triangle'; b.frequency.setValueAtTime(150, ctx.currentTime);
        b.frequency.exponentialRampToValueAtTime(40, ctx.currentTime + 0.2);
        bg.gain.setValueAtTime(1, ctx.currentTime); bg.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
        b.connect(bg); bg.connect(ctx.destination);
        const noise = ctx.createBufferSource(); const buf = ctx.createBuffer(1, ctx.sampleRate * 0.4, ctx.sampleRate);
        const d = buf.getChannelData(0); for(let i=0; i<buf.length; i++) d[i]=Math.random()*2-1;
        noise.buffer = buf; const ng = ctx.createGain();
        ng.gain.setValueAtTime(0.8, ctx.currentTime); ng.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        noise.connect(ng); ng.connect(ctx.destination);
        b.start(); noise.start(); b.stop(ctx.currentTime + 0.5);
    }

    function copyAIText() {
        let text = "【任務完了報告】ターゲットを仕留めました！\n" + archives.slice().reverse().map(t => `・${t.title} (H:${t.h} D:${t.d})`).join('\n');
        const ta = document.createElement("textarea"); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        alert("COPIED!");
    }

    initCamera();
    showScreen('hunt');
</script>
</body>
</html>
