<!DOCTYPE html>
<html lang="ja">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- アプリ化のための設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>WESTERN HUNTER</title>
    <style>
        :root {
            --gold: #d4af37;
            --paper: #e6d5b8;
            --ink: #2b1e16;
            --red: #a00000;
            --blue: #2196f3;
        }

        body, html {
            margin: 0; padding: 0; height: 100%;
            background: #1a110a;
            font-family: 'Palatino', serif;
            color: var(--gold);
            overflow: hidden;
            user-select: none;
        }

        .screen {
            display: none; height: calc(100vh - 85px); width: 100vw;
            flex-direction: column; align-items: center;
            overflow-y: auto;
            background-image: url('https://www.transparenttextures.com/patterns/dark-wood.png');
            -webkit-overflow-scrolling: touch;
        }
        .active { display: flex; }

        header {
            width: 100%; padding: 15px 0 10px 0;
            background: rgba(0,0,0,0.9);
            text-align: center; border-bottom: 2px solid var(--gold);
            z-index: 100;
        }

        .nav-bar { display: flex; justify-content: space-around; width: 100%; margin-top: 8px; }
        .nav-btn {
            background: none; border: 1px solid var(--gold); color: var(--gold);
            padding: 6px 10px; font-size: 0.7rem; border-radius: 3px; font-weight: bold;
        }
        .nav-btn.current { background: var(--gold); color: #000; }

        /* --- HUNT SCREEN --- */
        .hunt-top {
            width: 100%; min-height: 160px; flex-shrink: 0;
            background: radial-gradient(circle, #333, #000);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            border-bottom: 1px solid var(--gold);
        }
        .add-trigger {
            width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--gold);
            background: transparent; color: var(--gold); font-size: 24px;
        }
        .recent-names {
            width: 100%; padding: 8px; display: flex; flex-wrap: wrap; gap: 4px;
            background: rgba(0,0,0,0.4); justify-content: center;
        }
        .name-chip {
            background: var(--ink); color: var(--gold); border: 0.5px solid var(--gold);
            padding: 3px 8px; border-radius: 10px; font-size: 0.6rem;
        }

        /* --- DUEL SCREEN (2列) --- */
        #board {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 10px; padding: 12px; width: 100%; box-sizing: border-box;
        }
        .slot { aspect-ratio: 3/4.8; position: relative; }
        .poster {
            background-color: var(--paper); padding: 5px; display: flex; flex-direction: column;
            color: var(--ink); border: 1px solid #8b4513; position: absolute; inset: 0;
            box-shadow: 2px 2px 6px rgba(0,0,0,0.6);
        }
        .poster img { width: 100%; height: 55%; object-fit: cover; border: 0.5px solid var(--ink); filter: sepia(0.6); }
        .eliminate-btn {
            background: var(--red); color: white; border: none; padding: 10px 0;
            font-weight: bold; font-size: 0.8rem; border-radius: 2px; margin-top: 4px;
        }

        /* --- ARCHIVE SCREEN (3列高密度) --- */
        #archive-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); /* 3列に変更 */
            gap: 6px; padding: 8px; width: 100%; box-sizing: border-box;
        }
        .archive-card {
            background: var(--paper); border: 0.5px solid #8b4513;
            aspect-ratio: 3/5; display: flex; flex-direction: column;
            position: relative; font-size: 0.45rem; color: var(--ink);
            box-shadow: 1px 1px 4px rgba(0,0,0,0.5);
        }
        .archive-card img { width: 100%; height: 50%; object-fit: cover; filter: grayscale(1) sepia(0.3); opacity: 0.8; }
        .stamp {
            position: absolute; top: 10%; left: 0; right: 0; text-align: center;
            color: var(--red); font-weight: bold; border: 1.5px solid var(--red);
            transform: rotate(-15deg); font-size: 0.6rem; background: rgba(230,213,184,0.7); z-index: 5;
        }
        .restore-btn {
            background: var(--blue); color: white; border: none; padding: 3px;
            font-size: 0.4rem; margin-top: 2px; border-radius: 1px; width: 100%;
        }

        /* 銃撃演出 */
        .bullet-hole {
            position: absolute; width: 30px; height: 30px;
            background: radial-gradient(circle, #000 20%, #222 40%, transparent 70%);
            top: 30%; left: 50%; transform: translate(-50%, -50%);
            z-index: 10; display: none;
        }
        .is-shot { animation: shoot-down 0.7s ease-in forwards; pointer-events: none; }
        @keyframes shoot-down {
            0% { transform: scale(1); }
            10% { transform: scale(1.1); filter: brightness(4); }
            100% { transform: translateY(100vh) rotate(30deg); opacity: 0; }
        }
        .shake { animation: shake-anim 0.05s 4; }
        @keyframes shake-anim { 0%, 100% { transform: translate(0); } 50% { transform: translate(8px, 8px); } }

        #camera-input { display: none; }
    </style>
</head>
<body id="main-body">

    <header>
        <h1 style="font-size: 0.9rem; margin:0; letter-spacing: 2px;">WESTERN HUNTER</h1>
        <div class="nav-bar">
            <button class="nav-btn" id="btn-hunt" onclick="showScreen('hunt')">HUNT</button>
            <button class="nav-btn" id="btn-board" onclick="showScreen('board')">DUEL</button>
            <button class="nav-btn" id="btn-archive" onclick="showScreen('archive')">ARCHIVE</button>
        </div>
    </header>

    <div id="screen-hunt" class="screen active">
        <div class="hunt-top">
            <div style="font-size: 0.6rem; margin-bottom: 8px; opacity:0.7;">PICK NAME OR HIT +</div>
            <div class="recent-names" id="recent-names"></div>
            <button class="add-trigger" onclick="openCamera()">＋</button>
            <p id="ammo-count" style="margin-top:8px; font-size: 0.7rem;">STOCK: 0 / 10</p>
        </div>
        <div class="stock-list" id="stock-list" style="width:100%; padding:10px; box-sizing:border-box;"></div>
    </div>

    <div id="screen-board" class="screen">
        <div id="board"></div>
    </div>

    <div id="screen-archive" class="screen">
        <div style="width:100%; text-align:center; padding:10px;">
            <button style="background:var(--gold); color:#000; border:none; padding:10px; font-weight:bold; border-radius:4px; font-size:0.7rem; width:80%;" onclick="copyAIText()">AI報告用コピー</button>
        </div>
        <div id="archive-grid"></div>
    </div>

    <input type="file" id="camera-input" accept="image/*" capture="environment">

<script>
    let targets = JSON.parse(localStorage.getItem('w_act_v8') || '[]');
    let archives = JSON.parse(localStorage.getItem('w_arc_v8') || '[]');
    let selectedRecentName = "";
    const body = document.getElementById('main-body');

    function showScreen(mode) {
        save();
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('current'));
        document.getElementById(`screen-${mode}`).classList.add('active');
        document.getElementById(`btn-${mode}`).classList.add('current');
        render();
    }

    function render() {
        // --- HUNT ---
        const recentNamesDiv = document.getElementById('recent-names');
        const allNames = [...new Set(archives.map(a => a.title))].reverse().slice(0, 8);
        recentNamesDiv.innerHTML = '';
        allNames.forEach(name => {
            const chip = document.createElement('div');
            chip.className = 'name-chip';
            chip.innerText = name;
            chip.onclick = () => { selectedRecentName = name; openCamera(); };
            recentNamesDiv.appendChild(chip);
        });

        const stockList = document.getElementById('stock-list');
        stockList.innerHTML = `<div style="font-size:0.7rem; border-bottom:1px solid var(--gold); margin-bottom:8px;">STOCK LIST</div>`;
        targets.forEach(t => {
            stockList.innerHTML += `<div style="display:flex; align-items:center; background:rgba(255,255,255,0.05); margin-bottom:4px; padding:5px; font-size:0.7rem;">
                <img src="${t.image}" style="width:30px;height:30px;object-fit:cover;margin-right:8px;">${t.title}</div>`;
        });
        document.getElementById('ammo-count').innerText = `STOCK: ${targets.length} / 10`;

        // --- DUEL ---
        const board = document.getElementById('board');
        board.innerHTML = '';
        targets.forEach(t => {
            const slot = document.createElement('div');
            slot.className = 'slot';
            if (t.isPending) {
                slot.innerHTML = `<div style="display:flex; height:100%; justify-content:center; align-items:center; opacity:0.1; font-size:1.5rem;">☠</div>`;
            } else {
                slot.innerHTML = `<div class="poster" id="p-${t.id}">
                    <img src="${t.image}">
                    <div class="bullet-hole"></div>
                    <div style="flex-grow:1; display:flex; flex-direction:column; justify-content:space-between; padding:2px;">
                        <div style="text-align:center; font-size:0.6rem; font-weight:bold; overflow:hidden;">${t.title}</div>
                        <button class="eliminate-btn" onclick="shoot(${t.id})">SHOOT</button>
                    </div>
                </div>`;
            }
            board.appendChild(slot);
        });

        // --- ARCHIVE (3列) ---
        const arcGrid = document.getElementById('archive-grid');
        arcGrid.innerHTML = '';
        archives.slice().reverse().forEach((t, idx) => {
            const realIdx = archives.length - 1 - idx;
            arcGrid.innerHTML += `
                <div class="archive-card">
                    <div class="stamp">DEAD</div>
                    <img src="${t.image}">
                    <div style="padding:2px; text-align:center; flex-grow:1; display:flex; flex-direction:column; justify-content:space-around;">
                        <div style="font-weight:bold; overflow:hidden; white-space:nowrap;">${t.title}</div>
                        <div style="opacity:0.6;">${t.doneDate}</div>
                        <button class="restore-btn" onclick="restore(${realIdx})">RESTORE</button>
                    </div>
                </div>`;
        });
    }

    function openCamera() {
        if (targets.length >= 10) { alert("FULL!"); return; }
        document.getElementById('camera-input').click();
    }

    document.getElementById('camera-input').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        let title = selectedRecentName || prompt("NAME:");
        selectedRecentName = "";
        if (!title) return;

        const reader = new FileReader();
        reader.onload = (ev) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const scale = 300 / img.width;
                canvas.width = 300; canvas.height = img.height * scale;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                targets.push({
                    id: Date.now(),
                    title: title.toUpperCase(),
                    image: canvas.toDataURL('image/jpeg', 0.6),
                    date: `${new Date().getMonth()+1}/${new Date().getDate()}`,
                    isPending: false
                });
                save();
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    };

    function shoot(id) {
        playHeavyGunshot();
        body.classList.add('shake');
        const poster = document.getElementById(`p-${id}`);
        poster.querySelector('.bullet-hole').style.display = 'block';
        poster.classList.add('is-shot');
        const target = targets.find(t => t.id === id);
        if (target) {
            target.isPending = true;
            const now = new Date();
            archives.push({ ...target, doneDate: `${now.getMonth()+1}/${now.getDate()}`, isPending: false });
        }
        setTimeout(() => body.classList.remove('shake'), 500);
    }

    function restore(index) {
        if (targets.length >= 10) { alert("FULL!"); return; }
        const revived = archives.splice(index, 1)[0];
        revived.isPending = false;
        targets.push(revived);
        save();
    }

    function save() {
        targets = targets.filter(t => !t.isPending);
        localStorage.setItem('w_act_v8', JSON.stringify(targets));
        localStorage.setItem('w_arc_v8', JSON.stringify(archives));
        render();
    }

    function copyAIText() {
        if (!archives.length) return;
        let text = "【任務完了報告】仕留めたターゲットです！褒めてください！\n\n";
        archives.slice().reverse().forEach(t => text += `・${t.doneDate}：${t.title}\n`);
        const ta = document.createElement("textarea");
        ta.value = text; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy');
        document.body.removeChild(ta);
        alert("COPIED!");
    }

    function playHeavyGunshot() {
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const b = ctx.createOscillator(); const bg = ctx.createGain();
            b.type = 'triangle'; b.frequency.setValueAtTime(150, ctx.currentTime);
            b.frequency.exponentialRampToValueAtTime(40, ctx.currentTime + 0.2);
            bg.gain.setValueAtTime(1, ctx.currentTime); bg.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
            b.connect(bg); bg.connect(ctx.destination);
            const noise = ctx.createBufferSource();
            const buf = ctx.createBuffer(1, ctx.sampleRate * 0.4, ctx.sampleRate);
            const d = buf.getChannelData(0); for(let i=0; i<buf.length; i++) d[i]=Math.random()*2-1;
            noise.buffer = buf; const ng = ctx.createGain();
            ng.gain.setValueAtTime(0.8, ctx.currentTime); ng.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
            noise.connect(ng); ng.connect(ctx.destination);
            b.start(); noise.start(); b.stop(ctx.currentTime + 0.5);
        } catch(e) {}
    }

    showScreen('hunt');
</script>
</body>
</html>
